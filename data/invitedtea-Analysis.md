# Althea Liquid Infrastructure Contracts - Audit Analysis

- [Althea Liquid Infrastructure Contracts - Audit Analysis](#althea-liquid-infrastructure-contracts---audit-analysis)
  - [Project Description](#project-description)
    - [**Althea Liquid Infrastructure Contracts**](#althea-liquid-infrastructure-contracts)
    - [**Key Components**:](#key-components)
  - [LiquidInfrastructureERC20 Smart Contract Overview](#liquidinfrastructureerc20-smart-contract-overview)
    - [Core Concepts](#core-concepts)
    - [Key Functionalities](#key-functionalities)
    - [Events](#events)
    - [Security Features](#security-features)
    - [Constructor and Initialization](#constructor-and-initialization)
    - [Overall Purpose](#overall-purpose)
  - [LiquidInfrastructureNFT Smart Contract Overview](#liquidinfrastructurenft-smart-contract-overview)
    - [Core Concepts](#core-concepts-1)
    - [Key Functionalities](#key-functionalities-1)
    - [Events](#events-1)
    - [Security Features](#security-features-1)
    - [Constructor and Initialization](#constructor-and-initialization-1)
    - [Overall Purpose](#overall-purpose-1)
  - [OwnableApprovableERC721 Smart Contract Overview](#ownableapprovableerc721-smart-contract-overview)
    - [Core Concepts](#core-concepts-2)
    - [Key Functionalities](#key-functionalities-2)
    - [Events](#events-2)
    - [Security Features](#security-features-2)
    - [Constructor and Initialization](#constructor-and-initialization-2)
    - [Overall Purpose](#overall-purpose-2)
  - [Approach](#approach)
  - [Audit Practices for this Project](#audit-practices-for-this-project)
      - [Codebase Quality](#codebase-quality)
  - [Systemic \& Centralization Risks](#systemic--centralization-risks)
  - [Recommendations](#recommendations)
  - [Gas Efficiency](#gas-efficiency)
  - [Final Thoughts](#final-thoughts)


## Project Description
### **Althea Liquid Infrastructure Contracts**
Althea Liquid Infrastructure Contracts propose an innovative approach to tokenizing real-world assets and generating revenue through these tokenized assets on-chain. These contracts include capabilities for both NFTs and ERC20 tokens, enabling complex revenue distribution models and asset management. Key features and highlights:
- **Revenue-Generating NFTs**: These NFTs represent real-world assets that can generate revenue, managed through smart contracts for automated distribution.
- **ERC20 Token Aggregation**: An ERC20 layer allows for the aggregation of multiple NFTs, distributing revenue proportionally to token holders without requiring active claims.
- **Flexible Asset Representation**: The system can represent various asset types, such as routers in a network, vending machines, or renewable energy sources, demonstrating a wide application range.

### **Key Components**:
- **LiquidInfrastructureERC20.sol**: Manages revenue withdrawal from NFTs and distribution to ERC20 holders.
- **LiquidInfrastructureNFT.sol**: Accumulates ERC20 balances, allowing for permissioned balance withdrawals representing the tokenized asset.
- **OwnableApprovableERC721.sol**: Provides a foundation for NFT ownership and approval statuses, supporting the overall functionality of the NFT component.


## LiquidInfrastructureERC20 Smart Contract Overview

The `LiquidInfrastructureERC20` smart contract is designed to facilitate investment in real-world assets, specifically infrastructure assets represented by `LiquidInfrastructureNFTs`, within the Althea pay-per-forward network. This network involves infrastructure assets providing automated services, such as internet access, and receiving payments for these services.

### Core Concepts

- **ERC20 Token:** Operates as an ERC20 token, allowing for the creation (minting) and destruction (burning) of tokens, in addition to standard token transfer capabilities.

- **Revenue Distribution:** Aggregates revenue generated by `LiquidInfrastructureNFTs` (which represent real-world infrastructure assets) and distributes this revenue to ERC20 token holders, enabling them to earn rewards from the underlying assets.

- **NFT Management:** Manages a collection of `LiquidInfrastructureNFTs`, which are expected to generate revenue by providing services in the network.

### Key Functionalities

- **Holder Allowlist:** Maintains a whitelist (`HolderAllowlist`) of addresses approved to hold the ERC20 tokens, ensuring that only authorized participants can receive and hold tokens.

- **Distribution Mechanism:** Implements a mechanism that periodically distributes revenue from the `LiquidInfrastructureNFTs` to ERC20 token holders, subject to a minimum interval (`MinDistributionPeriod`) between distributions.

- **Locking for Distribution:** Can lock transfers, minting, and burning of tokens during the distribution process (`LockedForDistribution`) to ensure a fair and orderly distribution of revenue.

- **Managed NFTs:** Tracks `ManagedNFTs`, which are the `LiquidInfrastructureNFT` contracts that the ERC20 contract manages and from which it can withdraw revenue for distribution.

- **Minting and Burning:** Allows for minting new tokens and burning existing tokens, subject to certain conditions like adherence to the minimum distribution period and not being locked for distribution.

- **Withdrawals from NFTs:** Initiates withdrawals of revenue from managed `LiquidInfrastructureNFTs`, bringing the funds into the ERC20 contract for subsequent distribution to token holders.

### Events

The contract emits various events to signal actions such as deployment, the start and end of distributions, withdrawals, and changes in the managed NFTs.

### Security Features

- **ReentrancyGuard:** Includes OpenZeppelin's `ReentrancyGuard` to prevent reentrancy attacks, a common vulnerability in contracts that perform external calls.

- **Ownable:** Uses OpenZeppelin's `Ownable` pattern, allowing certain functions to be restricted to the contract owner.

### Constructor and Initialization

Upon deployment, the constructor initializes the contract with specific parameters such as the name and symbol of the ERC20 token, the initial set of managed NFTs, approved holders, the minimum distribution period, and the ERC20 tokens eligible for distribution.

### Overall Purpose

The contract aims to provide a streamlined way for investors to participate in the earnings of infrastructure assets within the Althea network by holding an ERC20 token that represents a share in the aggregated revenue from these assets. It balances the need for regular revenue distributions with the need to maintain token liquidity and security.

## LiquidInfrastructureNFT Smart Contract Overview

### Core Concepts
The `LiquidInfrastructureNFT` smart contract represents a unique approach to integrating blockchain assets with real-world infrastructure services, particularly within the Althea network's ecosystem. It leverages NFTs (Non-Fungible Tokens) to symbolize ownership and control over infrastructure accounts, which can accrue revenue in the form of ERC20 tokens based on the services provided, such as internet access in a pay-per-forward network model.

### Key Functionalities
- **Threshold Management (`setThresholds`):** Enables setting and updating the balance thresholds for different ERC20 tokens. These thresholds determine the minimum balances to be retained in the infrastructure accounts, with any excess amounts being transferable to the NFT contract for withdrawal.
- **ERC20 Withdrawals (`withdrawBalances`, `withdrawBalancesTo`):** Facilitates the withdrawal of accumulated ERC20 token balances from the NFT contract either to the owner's address or a specified destination. This function ensures that only the owner or an approved entity can access the funds.
- **Account Recovery (`recoverAccount`):** Initiates a recovery process for the associated infrastructure account, useful in scenarios where the original device or wallet controlling the account is lost. This process triggers the transfer of all account balances to the NFT contract for secure withdrawal.

### Events
- **`SuccessfulWithdrawal`**: Emitted after a successful withdrawal operation, detailing the recipient address, the ERC20 tokens withdrawn, and their respective amounts.
- **`TryRecover`**: Signals the initiation of the account recovery process, intended to be detected by external modules (e.g., x/microtx) for further action.
- **`SuccessfulRecovery`**: Indicates the completion of the recovery process, listing the ERC20 tokens and amounts transferred to the NFT contract.
- **`ThresholdsChanged`**: Announced when the balance thresholds for ERC20 tokens are updated, providing the new token addresses and threshold amounts.

### Security Features
- **Reentrancy Protection**: While not explicitly included in the provided snippet, adding `ReentrancyGuard` from OpenZeppelin can enhance security by preventing reentrancy attacks in withdrawal functions.
- **Access Control**: Utilizes a custom `onlyOwnerOrApproved` modifier to restrict sensitive operations such as setting thresholds and initiating withdrawals to the NFT's owner or approved entities.

### Constructor and Initialization
Upon deployment, the constructor sets the NFT's URI and symbol based on the provided `accountName`, representing the associated infrastructure account. It also mints a unique token (ID=1) to signify ownership and control over the infrastructure account.

### Overall Purpose
The `LiquidInfrastructureNFT` contract is designed to bridge physical infrastructure assets with blockchain technology, allowing for decentralized revenue generation and management within the Althea network. It introduces a novel mechanism for infrastructure owners to monetize their assets through microtransactions and provides a secure method for managing and accessing accrued funds.

## OwnableApprovableERC721 Smart Contract Overview

### Core Concepts
The `OwnableApprovableERC721` is an abstract smart contract that extends ERC721 functionality to include access control modifiers based on token ownership and approval. It is designed to provide fine-grained access control for functions that should only be executed by the token owner or an approved delegate.

### Key Functionalities
- **`onlyOwner(uint256 tokenId)` Modifier:**
  This modifier restricts function access to the owner of a specific token. It is ideal for actions that should be exclusively performed by the token owner, such as token customization or private interactions within a decentralized application.

- **`onlyOwnerOrApproved(uint256 tokenId)` Modifier:**
  Allows function execution by either the token owner or an entity approved by the owner. This modifier expands access control to include approved operators, facilitating cooperative management of tokens and enabling delegated actions.

### Events
The contract itself does not define new events but relies on the inherent events of the ERC721 standard, such as `Transfer` and `Approval`, to monitor ownership and approval changes. Implementing contracts may introduce custom events to signal specific actions taken under these access controls.

### Security Features
- **Explicit Access Control:**
  The contract leverages ERC721's ownership and approval checks to create secure, token-specific access controls, preventing unauthorized access and ensuring that only legitimate parties can perform certain operations.

- **Reusability and Compatibility:**
  As an abstract contract, `OwnableApprovableERC721` serves as a secure, reusable foundation that can be extended by other NFT contracts to inherit robust access control mechanisms without reinventing the wheel.

### Constructor and Initialization
Being an abstract contract, `OwnableApprovableERC721` does not have a constructor. Contracts that inherit from `OwnableApprovableERC721` will need to implement their own constructors, ensuring they properly initialize the ERC721 part of the contract, such as setting the token name and symbol.

### Overall Purpose
The primary purpose of the `OwnableApprovableERC721` contract is to enhance the ERC721 standard with additional access control features, making it easier for developers to enforce ownership or approval-based restrictions on token interactions. This contract is particularly useful in scenarios requiring strict control over who can perform certain actions with a token, such as in gaming, digital collectibles, or any application where token-specific permissions are critical.



## Approach
The audit focused on ensuring the security of the contracts, focusing on the integrity of revenue distribution, prevention of denial-of-service (DoS) attacks, and unauthorized access or acquisition of tokens and rewards. Specific areas of focus included:
1. **Revenue Distribution Logic**: Ensuring fairness and correctness in calculating and distributing earnings to holders.
2. **Contract Security**: Identifying potential vulnerabilities that could be exploited to disrupt service or misappropriate funds.
3. **Access Control Mechanisms**: Verifying that only authorized entities can perform sensitive operations.

---

## Audit Practices for this Project
- **Automated Analysis**: Utilized tools such as Slither and Mythril to scan for commonly known vulnerabilities and anti-patterns.
- **Manual Review**: Conducted a thorough line-by-line code review to understand business logic, identify edge cases, and ensure that the set security measures were robust.
- **Gas Efficiency**: Analyzed function calls and loops to provide recommendations for optimizing gas costs without compromising security.

#### Codebase Quality
The codebase exhibits a high level of clarity and organization, leveraging OpenZeppelin's libraries for standardized, secure contract development. The thoughtful separation of concerns between the ERC20 and NFT components facilitates code maintainability and scalability.

## Systemic & Centralization Risks
The design inherently centralizes revenue distribution within the `LiquidInfrastructureERC20.sol`, imposing risks if the distribution mechanism becomes compromised. Additionally, the system's reliance on the correct integration of external revenue sources for the NFTs can introduce external points of failure.

## Recommendations
1. **Implement Circuit Breakers**: Introduce pause functionality that can be triggered by designated roles to halt distributions in the event of an identified security threat or malfunction.
2. **Enhance Oracle Reliability**: For assets generating revenue through external mechanisms, ensure that multiple sources or decentralized oracles validate revenue amounts to mitigate single points of failure.
3. **Optimize for Gas Usage**: Where applicable, refactor loops and state updates to minimize transaction costs, potentially incorporating off-chain calculations with on-chain verification when feasible.

## Gas Efficiency
The current implementation illustrates an awareness of gas optimization principles, yet further improvements can be made. Recommendations include utilizing `storage` variables judiciously and adopting efficient data structures like mappings over arrays when possible.

## Final Thoughts
The Althea Liquid Infrastructure Contracts present a pioneering model for tokenizing and monetizing real-world assets on-chain. While the codebase demonstrates a strong foundation in security principles, attention to potential centralization and external dependency risks will be critical in ensuring the platform's resilience and trustworthiness. The recommended adjustments, particularly around gas optimization and fail-safes, could further solidify the contracts' efficiency and robustness, paving the way for broader adoption and application of the technology.

### Time spent:
16 hours