#  **Advanced Analysis Report for Althea Liquid Infrastructure**

[Audit approach](#1-audit-approach)

[Brief Overview](#2-brief-overview)

[Scope and Architecture Overview](#3-scope-and-architecture-overview)

[Codebase Overview](#4-codebase-overview)

[Centralization Risks](#5-centralization-risks)

[Systemic Risks](#6-systemic-risks)

[Recommendations](#7-recommendations)

[Conclusions](#8-conclusions)

[Resources](#9-resources)

***

## **1. Audit approach**

**Phase 1**: Protocol Familiarization: The review began by analyzing the protocol documentation, including the readMe, AthleaLI blog and whitepaper. followed by a preliminary examination of the relevant contracts and their tests.

**Phase 2**: Deep Contract Review: A meticulous, line-by-line review of the in-scope contracts was conducted, meticulously following the expected interaction flow.

**Phase 3**: Issue Discussion and Resolution: Potential pitfalls identified during the review were discussed with the developers to clarify whether they were genuine issues or intentional features of the protocol.

**Phase 4**: Reporting: Audit reports were finalized based on the findings.

***
## **2. Brief Overview**

- Liquid Infrastructure aims to bridge the gap between traditional assets and the blockchain, offering a new way to invest and manage real-world assets with potential for wider accessibility and transparency.
- It works by tokenizing real-world assets and turning them into digital tokens (LiquidInfrastructureNFTs) on the Althea blockchain, thereby creating investment opportunities and offering the LiquidInfrastructureERC20 token as proof of ownership and lets people share in the revenue generated by these assets.
***
## **3. Scope and Architecture Overview**

<p align="center">
    <img width= auto src="https://gist.github.com/assets/112232336/0ba21bce-8d99-4776-b0d2-7ca3bd605757"
alt="Contract Architecture">
</p>

### **[LiquidInfrastructureERC20.sol](https://github.com/code-423n4/2024-02-althea-liquid-infrastructure/blob/main/liquid-infrastructure/contracts/LiquidInfrastructureERC20.sol)** 

- This LiquidInfrastructure token allows users invest in the network infrastructure. By owning this token, the user automatically earn a share of the service's revenue, paid out regularly.

**Reward distribution** - To go through the distribution of rewards to users holding the LiquidInfrastructure token, users call the `distribute` or `distributeToAllHolders` functions. This only works if the minimum distribution time is passed, upon which the contract is locked from transfers, mints and burns to ensure users get their fair share and prevent gaming the rewards process. Reward distirbution also occurs when the users mint or burn tokens. The owner calls the `mintAndDistribute` function to do this. Users call the `burnAndDistribute` and `burnFromAndDistribute` which distributes the rewards before burning the user's tokens.

**NFT management** - LiquidInfrastructureNFT contract can be added to the collection of managed NFTs by calling the `addManagedNFT` from which the token balances from the NFTs can be wihtdrawn into the custody of the ERC20 token contract by calling the `withdrawFromManagedNFTs` function. The owner can decide to send the NFT to another address by calling the `releaseManagedNFT` function.

<p align="center">
    <img width= auto src="https://gist.github.com/assets/112232336/652c1f80-32a0-41ca-b181-56671aa6af9f" alt="LiquidInfrastructureERC20.sol"> sLOC - 270
</p>



### **[LiquidInfrastructureNFT.sol](https://github.com/code-423n4/2024-02-althea-liquid-infrastructure/blob/main/liquid-infrastructure/contracts/LiquidInfrastructureNFT.sol)**

- This contract is an NFT that represents and controls "Liquid Infrastructure Accounts," which are special accounts in the Athlea chain that are linked to the Ethereum Virtual Machine (EVM) through a payment system called x/microtx. The NFT acts like a bank account which receives token payments for services provided on the network.The owner can withdraw the stored tokens later, and in case it the linked  device is lost, the owner can use the NFT to recover all the tokens.

**Balance withdrawal** - Users call the `withdrawBalances` function to withdraw their ERC20 balance to their accounts or any account of their choosing.

**Account recovery** - Users who have lost the device thier account is attached to, can call the `recoverAccount` function which starts the Liquid Infrastructure Account recovery process. It emits the `TryRecover` event for the x/microtx module to detect. The x/microtx module converts all tokens in the account to be converted to ERC20s and sent to this contract, and emits the `SuccessfulRecovery` event which confirms that the recovery is successful. After success, the users can then call the `withdrawBalances` function to send the recover the tokens.

<p align="center">
    <img width= auto src="https://gist.github.com/assets/112232336/318cf677-78eb-4cb0-8bd1-eee56e540365" alt="LiquidInfrastructureNFT.sol">
</p>
<p align="center">sLOC - 88</p>


### **[OwnableApprovableERC721.sol](https://github.com/code-423n4/2024-02-althea-liquid-infrastructure/blob/main/liquid-infrastructure/contracts/OwnableApprovableERC721.sol)**
- This is an abstract contract that enforces that the caller of any of the LiquidInfrastructureNFT's protected functions is either the owner or approved by the owner. It follows the ERC721 style of the `ownerOf` and `_isApprovedOrOwner` implementations which check if the caller is the owner, an approved operator or an approved spender. If the caller doesn't fall into any of these categories, the function reverts. 

<p align="center">
    <img width= auto src="https://gist.github.com/assets/112232336/976ca096-d7a4-4a32-b854-8619a1fe9936" alt="OwnableApprovableERC721.sol"> sLOC - 19
</p>

***
## **4. Codebase Overview**

- **Audit Information** - For the purpose of the security review, the Althea Liquid Infrastructure consists of three smart contracts totaling 377 SLoC. Its core design principle is inheritance, enabling efficient and flexible integration. It is scheduled to be deployed on the cosmos chain, giving each user the freedom to transact in and across all platforms. It operates independently of oracles and sidechains.

- **Documentation and NatSpec** - The codebase provides important resources in form of blogs and whitepaper documentation. These documents provide a general overview of the the protocol and its functionality. The contracts are well commented, not strictly to NatSpec but each function was well explained. It made the audit process easier.

- **Gas Optimization** - The codebase isn't very well optimized for gas usage. A number of basic gas saving techniques were ignored. No `Unchecked` in loops and subtractions, an older non gas efficient solidity version is used, custom errors are not implemented and so on. 

- **Error handling and Event Emission** -  Require errors with error strings is used in the codebase. Events are well handled, emitted for important parameter changes, although in some cases, they seemed to not follow the checks-effects-interaction patterns. 

- **Testability** - Test coverage is about 95% which is very gooed. The implemented tests are mosty unit tests which tests the basic functionalities of the functions and helped with basic bugs. The more complex parts of the codebase are however not fuzz tested.

- **Token Support** - The protocol works with the LiquidInfrastructure ERC721 token, LiquidInfrastructure ERC20 token and other ERC20 tokens. Owners are allowed to set their desired token, although the protocol doesn't aim to support non-standard tokens. The contracts implementations is also not suitable for non-standard ERC20 tokens.

- **Attack Vectors** - For a protcool of this size, various points of attack are to be considered, most important of which are gaming rewards distribution, bypassing disapprovals to gain rewards, stealing rewardds from other users and so on.

***

## **5. Centralization Risks** 

Like any protocol that incorporates admin functions, the actions of a malicious admin can leave the protcol vulnerable. So of them include:

- Setting the minimum distribution period so high that users will not be able to get rewards distributed.
- Maliciously removing users from holders list to prevent them from getting rewards, and so on.

***
## **6. Systemic Risks** 

- User activity is very important as the protcol will not really function if users are not very active in the protcol.
- Lack of a sweep function in the contracts can lead to loss of tokens that cannot be recovered,
- Lack of timelocks or pause protocols in place during emergency market conditions.
- Issues with external dependencies, solidity version bugs and open zeppelin contracts. 
- Issues from other smart contracts, which at best may be contained in the erring contracts, at worst affect the whole protocol.
***
## **7. Recommendations**

- The codebase should be sanitized, and the comments should also be brought up to date to conform with NatSpec.

- While the protocol explicitly allows the owners to choose whatever tokens they're interested in, using unsafe trransfer methods for token transfers is not advisable. Consider using safer methods instead;

- In the same vein, using ordinary `transferFrom` and `mint` methods to handle the LiquidityInfrastructureNFT carries the risk of losing the the token if sent to an account that cannot handle ERC721 tokens. Updating to safe methods is also recommended.

- The current reward entitlement model doesn't take into consideration that disapproved holders do not get tokens distributed to them. It is calculated as a function of the total LiquidInfrastructureERC20 token supply, rather than the supply belonging to the approved users. This unfairly reduces rewards given to approved users and should be improved upon.

- Disapproved holders who still hold the LiquidInfrastructure tokens are still allowed to transfer them. They can bypass this by using a thrid party approved holder, transferring the tokens to them, and receiving a reward through them in return. Consider fixing this by preventing disapproved holders from sending tokens, just as they can't receive tokens.

- The calculation for the user's entitlement doesn't account for different token decimals, hence, for certain token types, little or no rewards will be distributed due to rounding errors. Consider inplementing a multiplier to prevent these rounding errors.

- Two step variable and address updates should be implemented. Most of the setter functions implement the changes almost immediately which can be jarring for the contracts/users. Adding these fixes can help protect from mistakes and unexepected behaviour.

- A proper pause function can be implemented to protect users in cases of turbulent market situations and black swan events. It also helps prevent malicious activities or bugs from causing significant damage while the team investigates the potential issues without affecting users' funds.

- If the LiquidInfrastructureERC20 contract is desired to be upgradeable, judging by presence of a version, then consider importing upgradeable OpenZeppelin contracts instead of currently unupgradeable contracts. Introducing storage gaps are also needed.

- Testing should be improved, including invariant and fuzzing tests;

- Solidity and OpenZeppelin contract versions should be updated to the latest as they provide lots of benefits in security and optimization;

***
## **8. Conclusions**

In general, the codebase is compact, of small size but not very well-designed. As is the reason for the audit, the identified risks need to be fixed. Recommended measures should be implemented to protect the protocol from potential attacks. Timely audits and sanitizations should be conducted to keep the codebase fresh and up to date with evolving security times.
***
## **9. Resources**

- [C4 ReadMe](https://code4rena.com/audits/2024-02-althea-liquid-infrastructure#top)
- [Blog](https://medium.com/althea-mesh)
- [Whitepaper](https://github.com/althea-net/althea-whitepaper/blob/master/whitepaper.pdf)
- [Website](https://github.com/althea-net)

### Time spent:
018 hours